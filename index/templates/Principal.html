{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<title>Pawly</title>
{% endblock extra_head %}
{% block content %}
<main class="pt-4">
  <div class="container mx-auto px-4 max-w-4xl">
    <div class="w-full">
      {% include 'historias.html' %}
      {% comment %} Modal de subida de historia global para asegurar visibilidad {% endcomment %}
      <div id="modal-cargando-historia" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl px-8 py-8 flex flex-col items-center shadow-lg">
          <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" alt="Paticas"
            class="w-16 h-16 mb-4 animate-bounce">
          <span class="text-lg font-bold text-mint mb-2">Subiendo historia...</span>
          <span class="text-gray-500 text-sm">Por favor espera</span>
        </div>
      </div>

      {% if messages %}
      <div class="mb-4">
        {% for message in messages %}
        <div
          class="alert alert-{{ message.tags }} p-4 rounded-md shadow-md {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% if user_authenticated %}
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-start space-x-4">
          <img src="{% static 'img/logo1.png' %}" alt="Tu perfil"
            class="w-12 h-12 rounded-full border-2 border-[#00F5D4] object-cover">
          <form action="" method="post" enctype="multipart/form-data" class="flex-1" id="publicar-form"
            onsubmit="return mostrarModalPublicando(event);">
            {% csrf_token %}

            <div class="mb-4">
              <select name="mascota_id" id="mascota-select"
                class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#00F5D4] focus:bg-white transition-all duration-300">
                <option value="">¬øCon qu√© mascota quieres publicar? üêæ</option>
                {% for mascota in mascotas_usuario %}
                <option value="{{ mascota.pk }}">{{ mascota.name }}</option>
                {% endfor %}
              </select>
              <span id="mascota-error" class="hidden text-red-500 text-sm mt-1"></span>
            </div>

            <div class="mb-4">
              <textarea name="descripcion" required placeholder="¬øQu√© quieres compartir hoy?" rows="3"
                class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#00F5D4] focus:bg-white transition-all duration-300 resize-none"></textarea>
            </div>

            <div class="flex items-center justify-between mb-4">
              <label for="foto-upload"
                class="cursor-pointer flex items-center space-x-2 text-gray-600 hover:text-[#00F5D4] transition-colors">
                <i class="fas fa-image text-lg"></i>
                <span class="text-sm font-medium">Agregar foto</span>
                <input id="foto-upload" name="foto" type="file" accept="image/*" required class="hidden"
                  onchange="previewFoto(event)">
              </label>

              <img id="preview-img" src="#" alt="Preview"
                class="hidden w-12 h-12 object-cover rounded-xl border border-gray-200" />
            </div>

            <div class="flex justify-end">
              <button type="submit"
                class="bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all duration-300">
                <i class="fas fa-paper-plane mr-2"></i>Publicar
              </button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

      {% if posts %}
      {% for post in posts %}
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6 instagram-card">
        <div class="flex items-center px-6 py-4">
          <a href="{% url 'mascotaDetails' post.pet.pk %}">
          {% if post.pet.profile_photo_url %}
          <img src="{{ post.pet.profile_photo_url }}" alt="{{ post.pet.name }}"
            class="w-12 h-12 rounded-full border-2 border-[#00F5D4] object-cover mr-4">
          </a>
          {% else %}
          <a href="{% url 'mascotaDetails' post.pet.pk %}">
          <img src="{% static 'img/logo1.png' %}" alt="Patita azul"
            class="w-12 h-12 rounded-full border-2 border-[#00F5D4] object-cover mr-4">
          </a>
          {% endif %}
          <div class="flex-1">
            <span class="font-semibold text-gray-900">
              <a href="{% url 'mascotaDetails' post.pet.pk %}">{{ post.pet.name }}</a>
            </span>
            <span class="text-gray-500 font-normal">-{{ post.author.user.username }}</span>
            <div class="text-gray-500 text-sm">{{ post.created_at|date:"d M H:i" }}</div>
          </div>
          {% if post.pet.is_available_for_adoption and post.author.user != request.user %}
    <button
      onclick="showInterest('{{ post.pet.pk }}')"
      class="bg-mint hover:bg-green-400 text-white px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105"
    >
      üíï ¬°Me interesa adoptar!
    </button>
    {% elif post.author.user == request.user %}
    <a href="{% url 'editar_post' post.pk %}">
        <button
            class="p-2 rounded-full border-none bg-transparent shadow-none focus:outline-none"
        >
            <i class="fas fa-edit" title="Editar publicaci√≥n" style="color: #222; font-size: 1.25rem;"></i>
        </button>
    </a>
  <a href="{% url 'eliminar_post' post.pk %}" onclick="return confirm('¬øEst√°s seguro de que deseas eliminar esta publicaci√≥n?')">
    <button
      class="p-2 rounded-full border-none bg-transparent shadow-none focus:outline-none"
      style="background: none;"
    >
      <i class="fas fa-trash" title="Eliminar publicaci√≥n" style="color: #222; font-size: 1.25rem;"></i>
    </button>
  </a>
  {% endif %}
        </div>
        <div class="w-full bg-gray-100">
          <img src="{{ post.photo_url }}" alt="Post" class="object-cover w-full h-auto">
        </div>
        <div class="px-6 py-4">
          <div class="flex items-center mb-4">
            {% if user_authenticated %}
            <button
              class="like-btn {% if post.id in user_liked_post_ids %}text-red-500{% else %}text-gray-500{% endif %} hover:text-red-500 p-2 rounded-full hover:bg-red-50 mr-1">
              <i class="fas fa-heart text-xl"></i>
            </button>
            <style>
              /* Animaci√≥n pop r√°pida para el bot√≥n de like */
              .like-pop {
                animation: like-pop-anim 0.18s cubic-bezier(.4, 2, .6, 1);
              }

              @keyframes like-pop-anim {
                0% {
                  transform: scale(1);
                }

                60% {
                  transform: scale(1.35);
                }

                100% {
                  transform: scale(1);
                }
              }
            </style>
            {% else %}
            <a href="{% url 'login' %}"
              class="text-gray-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all duration-300 mr-1 block">
              <i class="fas fa-heart text-xl"></i>
            </a>
            {% endif %}
            <button
              class="text-gray-500 hover:text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-all duration-300 mr-1">
              <i class="fas fa-comment text-xl"></i>
              <span class="ml-1 text-xs align-middle font-semibold">{{ post.comments.count }}</span>
            </button>
            <!-- Bot√≥n de compartir eliminado -->
            <span class="ml-auto text-sm font-semibold text-gray-700 like-count">{{ post.likes.count }} Me gusta</span>
          </div>

          <div class="mb-4">
            <p class="text-gray-900">
              <span class="font-semibold text-gray-900">
                <a href="{% url 'mascotaDetails' post.pet.pk %}">{{ post.pet.name }}</a>
              </span>
              {% if post.content %} {{ post.content }}{% endif %}
            </p>
          </div>

          {% if post.comments.count > 0 %}
          <div class="mb-4 comments-box">
            {% if post.comments.count > 5 %}
            {% for comment in post.comments.all|slice:":5" %}
            <p class="text-sm text-gray-800 mb-1">
              <span class="font-semibold text-gray-900">
                {% if comment.user and comment.user.username %}
                {{ comment.user.username }}
                {% else %}
                Usuario
                {% endif %}
              </span> {{ comment.content }}
            </p>
            {% endfor %}
            <a href="#" class="text-sm text-gray-500 mb-2"
              onclick="this.nextElementSibling.style.display='block';this.style.display='none';return false;">Ver m√°s
              comentarios... </a>
            <div style="display:none;">
              {% for comment in post.comments.all|slice:"5:" %}
              <p class="text-sm text-gray-800 mb-1">
                <span class="font-semibold text-gray-900">
                  {% if comment.user and comment.user.username %}
                  {{ comment.user.username }}
                  {% else %}
                  Usuario
                  {% endif %}
                </span> {{ comment.content }}
              </p>
              {% endfor %}
            </div>
            {% else %}
            {% for comment in post.comments.all %}
            <p class="text-sm text-gray-800 mb-1">
              <span class="font-semibold text-gray-900">
                {% if comment.user and comment.user.username %}
                {{ comment.user.username }}
                {% else %}
                Usuario
                {% endif %}
              </span> {{ comment.content }}
            </p>
            {% endfor %}
            {% endif %}
          </div>
          {% endif %}

          <form method="post" action="" class="comment-form flex items-center border-t border-gray-100 pt-4 gap-3">
            {% csrf_token %}
            <img src="{% static 'img/logo1.png' %}" alt="Tu perfil"
              class="w-8 h-8 rounded-full border border-[#00F5D4] object-cover">
            <input type="hidden" name="comment_post_id" value="{{ post.id }}">
            <input type="text" name="comment_content"
              class="flex-1 bg-gray-50 border-0 rounded-full px-4 py-2 text-sm text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#00F5D4] focus:bg-white transition-all duration-300"
              placeholder="A√±ade un comentario..." {% if not user_authenticated %}disabled{% endif %} required>
            <span class="comment-msg hidden text-green-600 text-xs ml-2"></span>
            {% if not user_authenticated %}
            <a href="{% url 'login' %}"
              class="px-4 py-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all duration-300">Enviar</a>
            {% else %}
            <button type="submit"
              class="px-4 py-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all duration-300">Enviar</button>
            {% endif %}
          </form>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="text-center py-16 bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="text-6xl mb-6">üêæ</div>
        <h3 class="text-2xl font-bold text-gray-900 mb-3">No hay publicaciones a√∫n</h3>
        <p class="text-gray-500 mb-8 max-w-md mx-auto">S√© el primero en compartir una foto de tu mascota y conecta con
          otros amantes de los animales</p>
        {% if not user_authenticated %}
        <a href="{% url 'login' %}"
          class="inline-flex items-center space-x-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white px-8 py-4 rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all duration-300">
          <i class="fas fa-sign-in-alt"></i>
          <span>Iniciar sesi√≥n para publicar</span>
        </a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</main>

<div id="modal-publicando" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg flex flex-col items-center px-8 py-6">
    <div class="mb-2 text-lg font-semibold">Publicando...</div>
    <div class="flex gap-1">
      <span class="paw inline-block w-8 h-8 animate-bounce-brown" style="animation-delay:0s">
        <svg viewBox="0 0 24 24" fill="#8B5C2A" xmlns="http://www.w3.org/2000/svg">
          <circle cx="6" cy="8" r="3" />
          <circle cx="18" cy="8" r="3" />
          <ellipse cx="12" cy="17" rx="5" ry="3" />
          <circle cx="4" cy="17" r="1.5" />
          <circle cx="20" cy="17" r="1.5" />
        </svg>
      </span>
      <span class="paw inline-block w-8 h-8 animate-bounce-brown" style="animation-delay:0.15s">
        <svg viewBox="0 0 24 24" fill="#8B5C2A" xmlns="http://www.w3.org/2000/svg">
          <circle cx="6" cy="8" r="3" />
          <circle cx="18" cy="8" r="3" />
          <ellipse cx="12" cy="17" rx="5" ry="3" />
          <circle cx="4" cy="17" r="1.5" />
          <circle cx="20" cy="17" r="1.5" />
        </svg>
      </span>
      <span class="paw inline-block w-8 h-8 animate-bounce-brown" style="animation-delay:0.3s">
        <svg viewBox="0 0 24 24" fill="#8B5C2A" xmlns="http://www.w3.org/2000/svg">
          <circle cx="6" cy="8" r="3" />
          <circle cx="18" cy="8" r="3" />
          <ellipse cx="12" cy="17" rx="5" ry="3" />
          <circle cx="4" cy="17" r="1.5" />
          <circle cx="20" cy="17" r="1.5" />
        </svg>
      </span>
    </div>
  </div>
</div>

<!-- Modal de inter√©s -->
<div id="interestModal"
  class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4 animate-fadein">
  <div
    class="bg-white rounded-2xl shadow-lg max-w-md w-full overflow-hidden relative animate-slideup border border-gray-100">
    {% if adoption_success %}
    <div class="px-6 pt-7 pb-3 text-center border-b border-gray-100 bg-gray-50">
      <div class="flex justify-center mb-2">
        <i class="fas fa-paw text-2xl text-mint"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-1">¬°Gracias por tu inter√©s!</h3>
      <p class="text-gray-500 text-sm">El equipo de adopci√≥n se pondr√° en contacto contigo pronto para coordinar una
        visita.</p>
    </div>
    <div class="p-6 text-center">
      <button onclick="closeModal()"
        class="bg-mint text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-mint/90 transition-colors">Cerrar</button>
    </div>
    {% else %}
    <div class="px-6 pt-7 pb-3 text-center border-b border-gray-100 bg-gray-50">
      <div class="flex justify-center mb-2">
        <i class="fas fa-paw text-2xl text-mint"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-1">Formulario de adopci√≥n</h3>
      <p class="text-gray-500 text-sm">Completa el formulario para que el equipo de adopci√≥n se ponga en contacto
        contigo.</p>
    </div>
    <div class="p-6">
      <form method="post" class="space-y-5">
        {% csrf_token %}
        {% if form.errors %}
        <div class="text-red-600 text-sm mb-2 text-left">
          {{ form.errors }}
        </div>
        {% endif %}
        <div class="space-y-4">
          {% for field in form.visible_fields %}
          <div>
            <label for="{{ field.id_for_label }}" class="block text-xs font-medium text-gray-500 mb-1">
              {% if field.name == 'adopterName' %}
              Tu nombre completo
              {% elif field.name == 'adopterEmail' %}
              Tu correo electr√≥nico
              {% elif field.name == 'adopterPhone' %}
              Tu n√∫mero de tel√©fono
              {% elif field.name == 'message' %}
              Mensaje para el equipo de adopci√≥n
              {% else %}
              {{ field.label }}
              {% endif %}
            </label>
            <div class="flex items-center">
              {% if field.name == 'adopterName' %}
              <i class="fas fa-user text-gray-300 mr-2"></i>
              {% elif field.name == 'adopterEmail' %}
              <i class="fas fa-envelope text-gray-300 mr-2"></i>
              {% elif field.name == 'adopterPhone' %}
              <i class="fas fa-phone text-gray-300 mr-2"></i>
              {% elif field.name == 'message' %}
              <i class="fas fa-comment text-gray-300 mr-2"></i>
              {% endif %}
              <div class="flex-1">
                {{ field }}
              </div>
            </div>
            {% if field.errors %}
            <span class="text-xs text-red-500 mt-1 block">{{ field.errors|striptags }}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="flex gap-2 mt-6">
          <button type="button" onclick="closeModal()"
            class="flex-1 bg-gray-50 text-gray-500 py-2.5 rounded-lg font-medium hover:bg-gray-100 transition-colors border border-gray-200">Cancelar</button>
          <input type="hidden" name="pet_id" id="adoption-pet-id" value="">
          <button type="submit"
            class="flex-1 bg-mint text-white py-2.5 rounded-lg font-semibold hover:bg-mint/90 transition-colors">Enviar</button>
        </div>
      </form>
    </div>
    {% endif %}
    <button onclick="closeModal()"
      class="absolute top-3 right-3 text-gray-300 hover:text-mint text-lg focus:outline-none" title="Cerrar"><i
        class="fas fa-times"></i></button>
  </div>
</div>
<style>
  .animate-fadein {
    animation: fadein 0.3s;
  }

  .animate-slideup {
    animation: slideup 0.4s cubic-bezier(.4, 2, .6, 1) 0.05s;
  }

  @keyframes fadein {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes slideup {
    from {
      transform: translateY(40px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .text-mint {
    color: #00F5D4;
  }

  .bg-mint {
    background: #00F5D4;
  }

  .bg-mint\/90 {
    background: rgba(0, 245, 212, 0.9);
  }

  /* Minimalista para los inputs */
  #interestModal input,
  #interestModal textarea {
    background: #f7fafc;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 1rem;
    color: #222;
    padding: 0.75rem 1rem;
    transition: border 0.2s, box-shadow 0.2s;
    box-shadow: none;
    outline: none;
  }

  #interestModal input:focus,
  #interestModal textarea:focus {
    border-color: #00F5D4;
    background: #fff;
  }

  #interestModal textarea {
    min-height: 80px;
    resize: vertical;
  }
</style>

<style>
  .animate-bounce-brown {
    animation: bounce-brown 0.7s infinite alternate;
    display: inline-block;
  }

  @keyframes bounce-brown {
    0% {
      transform: translateY(0);
    }

    100% {
      transform: translateY(-16px);
    }
  }
</style>
{% block extra_scripts %}
<script>
  function showInterest() {
    document.getElementById("interestModal").classList.remove("hidden");
  }

  function showInterest(petId) {
    const modal = document.getElementById("interestModal");
    if (modal) modal.classList.remove('hidden');
    const hidden = document.getElementById('adoption-pet-id');
    if (hidden && petId) hidden.value = petId;
  }

  function closeModal() {
    document.getElementById("interestModal").classList.add("hidden");
  }
  function previewFoto(event) {
    const input = event.target;
    const preview = document.getElementById('preview-img');
    if (input.files && input.files[0]) {
      const file = input.files[0];

      // Validar tama√±o del archivo (5MB m√°ximo)
      if (file.size > 5 * 1024 * 1024) {
        alert('La imagen es demasiado grande. M√°ximo 5MB.');
        input.value = '';
        return;
      }

      // Validar tipo de archivo
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        alert('Tipo de archivo no v√°lido. Solo se permiten im√°genes (JPEG, PNG, GIF, WebP).');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.classList.remove('hidden');
      }
      reader.onerror = function () {
        alert('Error al cargar la imagen.');
        input.value = '';
        preview.classList.add('hidden');
      }
      reader.readAsDataURL(file);
    } else {
      preview.src = '#';
      preview.classList.add('hidden');
    }
  }

  function validarMascotaSeleccionada() {
    const select = document.getElementById('mascota-select');
    const error = document.getElementById('mascota-error');
    if (select && select.value === "") {
      error.textContent = "Por favor, elige con qu√© mascota quieres publicar üêæ";
      error.classList.remove('hidden');
      select.classList.add('border-pink-500');
      setTimeout(function () {
        error.classList.add('hidden');
        select.classList.remove('border-pink-500');
      }, 2500);
      return false;
    } else {
      error.classList.add('hidden');
      select.classList.remove('border-pink-500');
    }
    return true;
  }

  function validarFormularioCompleto() {
    const select = document.getElementById('mascota-select');
    const descripcion = document.querySelector('textarea[name="descripcion"]');
    const foto = document.getElementById('foto-upload');

    if (!validarMascotaSeleccionada()) {
      return false;
    }

    if (!descripcion.value.trim()) {
      alert('Por favor, escribe una descripci√≥n para tu publicaci√≥n.');
      descripcion.focus();
      return false;
    }

    if (!foto.files || foto.files.length === 0) {
      alert('Por favor, selecciona una imagen para tu publicaci√≥n.');
      return false;
    }

    return true;
  }

  function mostrarModalPublicando(event) {
    event.preventDefault();

    if (!validarFormularioCompleto()) {
      return false;
    }

    const modal = document.getElementById('modal-publicando');
    if (modal) {
      modal.classList.remove('hidden');
    }

    setTimeout(function () {
      event.target.submit();
    }, 500);

    return false;
  }

  document.addEventListener('DOMContentLoaded', function () {
    if (typeof Swiper !== 'undefined') {
      const swiper = new Swiper('.swiper', {
        slidesPerView: 'auto',
        spaceBetween: 12,
        freeMode: true,
        grabCursor: true
      });
    }


    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const modal = document.getElementById('modal-publicando');
      if (modal) {
        modal.classList.add('hidden');
      }
    }
  });
</script>
{% endblock %}
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/comments.js' %}"></script>
<script src="{% static 'js/like.js' %}"></script>
{% endblock content %}