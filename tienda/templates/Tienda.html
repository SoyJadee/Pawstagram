{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<title>Pawly -Tiendas</title>
{% endblock extra_head %}
{% block content %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Efecto parallax suave en las huellas
    window.addEventListener('scroll', () => {
      const scrolled = window.pageYOffset;
      const paws = document.querySelectorAll('.paw');
      paws.forEach((paw, index) => {
        const speed = 0.5 + (index * 0.1);
        paw.style.transform = `translateY(${scrolled * speed * 0.1}px)`;
      });
    });
    var btn = document.getElementById('closeMapModalInline');
    if (btn) {
      btn.addEventListener('click', function () {
        mapModal.classList.add('hidden');
        leafletMapDiv.innerHTML = '';
        if (leafletMap) {
          leafletMap.remove();
          leafletMap = null;
        }
        leafletMarkers = [];
        leafletRoute = null;
        if (window._routingControl) {
          window._routingControl.remove();
          window._routingControl = null;
        }
      });
    }

    // Cerrar modal al hacer clic fuera de la caja blanca
    var modal = document.getElementById('mapModal');
    var mapDiv = document.getElementById('leafletMap');
    if (modal) {
      modal.addEventListener('mousedown', function (e) {
        // Solo cerrar si el click fue en el fondo oscuro, no en la caja blanca
        if (e.target === modal) {
          modal.classList.add('hidden');
          mapDiv.innerHTML = '<div id="leafletMap" class="w-full h-96 min-h-[400px] rounded-xl border-2 border-turquesa mb-4"></div>';
          if (window.leafletMap) {
            window.leafletMap.remove();
            window.leafletMap = null;
          }
          window.leafletMarkers = [];
          window.leafletRoute = null;
          if (window._routingControl) {
            window._routingControl.remove();
            window._routingControl = null;
          }
        }
      });
    }
  });
</script>
<!-- BotÃ³n Volver fijo -->

<!DOCTYPE html>
<html lang="es">

<head>
  <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'mint': '#98E4D6',
            'light-blue': '#87CEEB',
            'soft-mint': '#E8F8F5',
            'turquesa': '#40E0D0',
            'verde-menta': '#98E4D6',
            'azul-claro': '#87CEEB'
          }
        }
      }
    }
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Ocultar el panel de instrucciones de Leaflet Routing Machine */
    .leaflet-routing-container {
      display: none !important;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #E8F8F5 0%, #F0F9FF 50%, #E0F2F1 100%);
    }

    .card-shadow {
      box-shadow: 0 4px 20px rgba(152, 228, 214, 0.15);
    }

    .gradient-border {
      background: linear-gradient(#fff, #fff) padding-box, linear-gradient(135deg, #98E4D6, #87CEEB) border-box;
      border: 2px solid transparent;
      border-radius: 2rem;
    }

    .store-card {
      transition: all 0.3s ease;
    }

    .store-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 8px 30px rgba(152, 228, 214, 0.18);
    }

    .inner-card {
      background: #fff;
      border-radius: 2rem;
      box-shadow: 0 2px 8px rgba(152, 228, 214, 0.08);
    }

    .paw-prints {
      display: flex;
      gap: 0.6rem;
      margin: 0rem;
      justify-content: center;
    }

    .paw {
      font-size: 1.2rem;
      color: #00F5D4;
      animation: bounce 2s infinite;
      animation-delay: calc(var(--delay) * 0.2s);
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }
  </style>

  <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Encuentra tu tienda ideal</h1>
      <!-- Huellas decorativas -->
      <div class="paw-prints">
        <span class="paw" style="--delay: 0">ğŸ¾</span>
        <span class="paw" style="--delay: 1">ğŸ¾</span>
        <span class="paw" style="--delay: 2">ğŸ¾</span>
        <span class="paw" style="--delay: 3">ğŸ¾</span>
        <span class="paw" style="--delay: 4">ğŸ¾</span>
        <span class="paw" style="--delay: 5">ğŸ¾</span>
        <span class="paw" style="--delay: 6">ğŸ¾</span>
        <span class="paw" style="--delay: 7">ğŸ¾</span>
        <span class="paw" style="--delay: 8">ğŸ¾</span>
        <span class="paw" style="--delay: 9">ğŸ¾</span>
        <span class="paw" style="--delay: 10">ğŸ¾</span>
        <span class="paw" style="--delay: 11">ğŸ¾</span>
        <span class="paw" style="--delay: 12">ğŸ¾</span>
        <span class="paw" style="--delay: 13">ğŸ¾</span>
        <span class="paw" style="--delay: 14">ğŸ¾</span>
        <span class="paw" style="--delay: 15">ğŸ¾</span>
        <span class="paw" style="--delay: 16">ğŸ¾</span>
        <span class="paw" style="--delay: 17">ğŸ¾</span>
        <span class="paw" style="--delay: 18">ğŸ¾</span>
        <span class="paw" style="--delay: 19">ğŸ¾</span>
      </div>
    </div>
  </div>
  </section>

  <!-- Tiendas Section -->
  <section class="pb-20">
    <div id="tiendas-container"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto justify-center h-full">
      {% for store in stores %}
      <div class="gradient-border store-card max-w-[340px] h-full flex flex-col" data-especies="todas">
        <div class="inner-card p-8 flex flex-col justify-between h-full">
          <div class="text-center mb-6">
            <div
              class="w-24 h-24 bg-gradient-to-r from-turquesa to-azul-claro rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg overflow-hidden">
              <img
                src="{{ store.photo_url|default:'https://emprendeconhuevos.com/wp-content/uploads/2020/12/WalMart-Centro-CDR-1-1.jpg' }}"
                alt="Perfil tienda" class="object-cover w-full h-full">
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2" data-store-id="{{ store.id }}">{{ store.name }}</h3>
            <p class="text-turquesa font-semibold">{{ store.owner }}</p>
          </div>
          <div class="space-y-4 mb-8">
            <div class="bg-gradient-to-r from-turquesa/10 to-azul-claro/10 p-4 rounded-xl">
              <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ UbicaciÃ³n</h4>
              <p class="text-gray-600">{{ store.location }}</p>
              <p class="text-sm text-gray-500">{{ store.created_at|date:'d M Y H:i' }}</p>
            </div>
            <div class="bg-gradient-to-r from-verde-menta/10 to-turquesa/10 p-4 rounded-xl">
              <h4 class="font-semibold text-gray-700 mb-2">â„¹ï¸ InformaciÃ³n</h4>
              <p class="text-gray-600 text-sm">{{ store.description }}</p>
            </div>
          </div>
          <a href="#"
            class="ver-mapa-btn w-full block py-4 bg-gradient-to-r from-turquesa to-azul-claro text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-center"
            data-lat="{{ store.latitude }}" data-lon="{{ store.longitude }}">
            Ver en mapa ğŸ“
          </a>
        </div>
      </div>
      {% empty %}
      <div class="col-span-3 text-center py-12">
        <h3 class="text-2xl font-bold text-gray-500">No hay tiendas registradas.</h3>
      </div>
      {% endfor %}
    </div>
    </div>
  </section>

  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <!-- Modal para el mapa -->
  <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-4 relative w-full max-w-2xl h-[500px] flex flex-col">
      <button id="closeMapModal"
        class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
      <div id="leafletMap" class="w-full h-96 min-h-[400px] rounded-xl border-2 border-turquesa mb-4"></div>
      <div class="flex flex-col md:flex-row justify-between items-center mt-2">
        <div class="flex gap-4 items-center">
          <span class="font-semibold text-gray-700">Distancia:</span>
          <span class="modal-distance text-turquesa font-bold"></span>
          <span class="font-semibold text-gray-700">DuraciÃ³n:</span>
          <span class="modal-duration text-turquesa font-bold"></span>
        </div>
        <div class="flex gap-2 justify-end w-full md:w-auto mt-4 md:mt-0">
          <button id="openMapAddress"
            class="bg-turquesa text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-turquesa/80 transition">Mostrar
            direcciÃ³n</button>
          <button id="closeMapModalInline"
            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold shadow hover:bg-gray-400 transition">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Sistema de filtros
    const filterButtons = document.querySelectorAll('.filter-btn');
    const storeCards = document.querySelectorAll('.store-card');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remover clase active y resetear estilos de todos los botones
        filterButtons.forEach(btn => {
          btn.classList.remove('active');
          btn.classList.remove('bg-turquesa', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        // Agregar clase active al botÃ³n clickeado
        button.classList.add('active');
        button.classList.remove('bg-gray-200', 'text-gray-700');
        button.classList.add('bg-turquesa', 'text-white');

        const filter = button.getAttribute('data-filter');

        storeCards.forEach(card => {
          const especies = card.getAttribute('data-especies');

          if (filter === 'todas' || especies.includes(filter)) {
            card.style.display = 'block';
            card.style.opacity = '0';
            setTimeout(() => {
              card.style.opacity = '1';
            }, 100);
          } else {
            card.style.opacity = '0';
            setTimeout(() => {
              card.style.display = 'none';
            }, 300);
          }
        });
      });
    });

    // Hacer clic en cualquier carta de tienda lleva a /tienda/catalogo/
    storeCards.forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', function (e) {
        // Evitar que el click en el botÃ³n de Google Maps dispare la redirecciÃ³n
        if (e.target.closest('button')) return;
        const storeId = this.querySelector('h3').getAttribute('data-store-id');
        if (storeId) {
          window.location.href = `/tienda/catalogo/${storeId}/`;
        }
      });
    });

    // Funcionalidad para botones de Google Maps
    document.querySelectorAll('button').forEach(button => {
      if (button.textContent.includes('Google Maps')) {
        button.addEventListener('click', function (e) {
          e.stopPropagation();
          const tienda = this.closest('.store-card').querySelector('h3').textContent;
          const ubicacion = this.closest('.store-card').querySelector('p').textContent;
          alert(`ğŸ—ºï¸ Abriendo ${tienda} en Google Maps\nUbicaciÃ³n: ${ubicacion}`);
        });
      }
    });

    // Modal de mapa
    const mapModal = document.getElementById('mapModal');
    const leafletMapDiv = document.getElementById('leafletMap');
    // Referencias a botones del modal
    const closeMapModal = document.getElementById('closeMapModal');
    const openMapAddress = document.getElementById('openMapAddress');
    let leafletMap = null;
    let leafletMarkers = [];
    let leafletRoute = null;

    function showLeafletMap(userLat, userLon, destLat, destLon, routeGeoJson) {
      // Inicializar el mapa solo una vez
      if (!leafletMap) {
        leafletMap = L.map('leafletMap').setView([destLat, destLon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap'
        }).addTo(leafletMap);
      } else {
        leafletMap.setView([destLat, destLon], 13);
        leafletMarkers.forEach(m => leafletMap.removeLayer(m));
        leafletMarkers = [];
        if (leafletRoute) {
          leafletMap.removeLayer(leafletRoute);
          leafletRoute = null;
        }
      }
      // Marcador destino
      const destMarker = L.marker([destLat, destLon]).addTo(leafletMap);
      leafletMarkers.push(destMarker);
      // Marcador usuario
      if (userLat && userLon) {
        const userMarker = L.marker([userLat, userLon], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png', iconSize: [32, 32] }) }).addTo(leafletMap);
        leafletMarkers.push(userMarker);
      }
      // Dibujar ruta realista si existe
      if (routeGeoJson) {
        leafletRoute = L.geoJSON(routeGeoJson, { style: { color: 'turquoise', weight: 4, opacity: 0.7 } }).addTo(leafletMap);
        leafletMap.fitBounds(L.geoJSON(routeGeoJson).getBounds(), { padding: [40, 40] });
      }
    }

    let lastCoords = '';
    let lastUserLat = null;
    let lastUserLon = null;
    let lastDestLat = null;
    let lastDestLon = null;




    document.querySelectorAll('.ver-mapa-btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        let destLat = this.getAttribute('data-lat');
        let destLon = this.getAttribute('data-lon');
        lastDestLat = destLat ? destLat.replace(',', '.') : null;
        lastDestLon = destLon ? destLon.replace(',', '.') : null;
        // Limpiar cualquier instancia previa de Leaflet y Routing Machine
        if (leafletMap) {
          leafletMap.remove();
          leafletMap = null;
        }
        leafletMarkers = [];
        leafletRoute = null;
        if (window._routingControl) {
          window._routingControl.remove();
          window._routingControl = null;
        }
        // No recrear el div, solo reutilizarlo
        if (lastDestLat && lastDestLon) {
          showLeafletMap(null, null, lastDestLat, lastDestLon, false);
          mapModal.classList.remove('hidden');
          setTimeout(() => {
            if (leafletMap) leafletMap.invalidateSize();
          }, 300);
        }
      });
    });


    closeMapModal.addEventListener('click', function () {
      mapModal.classList.add('hidden');
      leafletMapDiv.innerHTML = '';
      if (leafletMap) {
        leafletMap.remove();
        leafletMap = null;
      }
      leafletMarkers = [];
      leafletRoute = null;
      if (window._routingControl) {
        window._routingControl.remove();
        window._routingControl = null;
      }
    });

    openMapAddress.addEventListener('click', function () {
      // Al presionar 'Mostrar direcciÃ³n', consultar ruta por backend y dibujar con Polyline
      if (lastDestLat && lastDestLon) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            // Consultar ruta al backend (corrige IIFE no invocada y parÃ©ntesis extra)
            const getCSRF = (window.SecurityUtils && window.SecurityUtils.getCSRF) ? window.SecurityUtils.getCSRF : null;
            const csrfToken = (getCSRF ? getCSRF() : ((document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || ''));
            fetch('/salud/ruta-direcciones/', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
              },
              body: JSON.stringify({
                origen: [userLon, userLat],
                destino: [parseFloat(lastDestLon), parseFloat(lastDestLat)]
              })
            })
              .then(response => { if (!response.ok) throw new Error('HTTP ' + response.status); return response.json(); })
              .then(data => {
                if (data.routes && data.routes.length > 0) {
                  var route = data.routes[0];
                  var coords = [];
                  if (route.geometry && route.geometry.coordinates) {
                    coords = route.geometry.coordinates.map(function (c) { return [c[1], c[0]]; });
                  } else if (typeof route.geometry === 'string' && window.polyline) {
                    coords = window.polyline.decode(route.geometry);
                  } else if (route.geometry && Array.isArray(route.geometry)) {
                    coords = route.geometry.map(function (c) { return [c[1], c[0]]; });
                  } else {
                    alert('La geometrÃ­a de la ruta no estÃ¡ disponible en el formato esperado.');
                    return;
                  }
                  showLeafletMap(userLat, userLon, lastDestLat, lastDestLon, {
                    type: 'Feature',
                    geometry: {
                      type: 'LineString',
                      coordinates: coords.map(function (c) { return [c[1], c[0]]; })
                    }
                  });
                  // Distancia y duraciÃ³n
                  var km = (route.summary.distance / 1000).toFixed(2);
                  var min = Math.ceil(route.summary.duration / 60);
                  document.querySelectorAll('.modal-distance').forEach(function (el) {
                    el.textContent = km + ' km';
                  });
                  document.querySelectorAll('.modal-duration').forEach(function (el) {
                    el.textContent = min + ' minutos';
                  });
                } else {
                  showLeafletMap(userLat, userLon, lastDestLat, lastDestLon, null);
                  document.querySelectorAll('.modal-distance').forEach(function (el) {
                    el.textContent = 'No disponible';
                  });
                  document.querySelectorAll('.modal-duration').forEach(function (el) {
                    el.textContent = 'No disponible';
                  });
                  alert('No se pudo calcular la ruta.');
                }
              })
              .catch(() => {
                showLeafletMap(userLat, userLon, lastDestLat, lastDestLon, null);
                document.querySelectorAll('.modal-distance').forEach(function (el) {
                  el.textContent = 'No disponible';
                });
                document.querySelectorAll('.modal-duration').forEach(function (el) {
                  el.textContent = 'No disponible';
                });
                alert('Error de red al consultar la ruta.');
              });
          }, function () {
            showLeafletMap(null, null, lastDestLat, lastDestLon, null);
            document.querySelectorAll('.modal-distance').forEach(function (el) {
              el.textContent = 'No disponible';
            });
            document.querySelectorAll('.modal-duration').forEach(function (el) {
              el.textContent = 'No disponible';
            });
          });
        } else {
          showLeafletMap(null, null, lastDestLat, lastDestLon, null);
          document.querySelectorAll('.modal-distance').forEach(function (el) {
            el.textContent = 'No disponible';
          });
          document.querySelectorAll('.modal-duration').forEach(function (el) {
            el.textContent = 'No disponible';
          });
        }
      }
    });


    function showLeafletMap(userLat, userLon, destLat, destLon, routeFeature) {
      if (!leafletMap) {
        leafletMap = L.map('leafletMap').setView([destLat, destLon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap'
        }).addTo(leafletMap);
      } else {
        leafletMap.setView([destLat, destLon], 15);
        leafletMarkers.forEach(m => leafletMap.removeLayer(m));
        leafletMarkers = [];
        if (leafletRoute) {
          leafletMap.removeLayer(leafletRoute);
          leafletRoute = null;
        }
        if (window._routingControl) {
          window._routingControl.remove();
          window._routingControl = null;
        }
      }
      // Marcador destino
      const destMarker = L.marker([parseFloat(destLat), parseFloat(destLon)]).addTo(leafletMap);
      leafletMarkers.push(destMarker);
      // Marcador usuario
      if (userLat && userLon) {
        const userMarker = L.marker([parseFloat(userLat), parseFloat(userLon)], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png', iconSize: [32, 32] }) }).addTo(leafletMap);
        leafletMarkers.push(userMarker);
      }
      // Dibujar la ruta si existe
      if (routeFeature && routeFeature.geometry && routeFeature.geometry.coordinates) {
        // Leaflet espera [lat, lon], pero GeoJSON es [lon, lat], asÃ­ que invertimos
        const latLngs = routeFeature.geometry.coordinates.map(function (c) { return [c[1], c[0]]; });
        leafletRoute = L.polyline(latLngs, { color: '#0050b3', weight: 7, opacity: 0.95 }).addTo(leafletMap);
        leafletMap.fitBounds(leafletRoute.getBounds(), { padding: [40, 40] });
      }
      // Si solo se muestra el mapa, limpiar distancia/tiempo
      document.querySelectorAll('.modal-distance').forEach(function (el) {
        el.textContent = '';
      });
      document.querySelectorAll('.modal-duration').forEach(function (el) {
        el.textContent = '';
      });
    }
  </script>
  <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'98144066a56c7487',t:'MTc1ODIzNDI0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
  </body>

</html>
{% endblock content %}