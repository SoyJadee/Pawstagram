{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<title>Editar publicación — Pawly</title>
{% endblock extra_head %}

{% block content %}
<main class="container mx-auto max-w-3xl py-8 px-4">
    <header class="mb-6">
        <a href="{% url 'post_view' post.id %}" class="text-sm text-gray-600 hover:underline">← Volver al post</a>
        <h1 class="text-2xl font-bold mt-3">Editar publicación</h1>
        <p class="text-sm text-gray-500 mt-1">Edita el contenido y/o la imagen de tu publicación.</p>
    </header>

    <section class="bg-white rounded-xl shadow p-6">
        <form method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="toast {{ message.tags }} bg-white border border-gray-200 rounded-lg p-3 mb-2">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="grid grid-cols-1 gap-6 md:grid-cols-3 md:gap-8 items-start">
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Imagen actual</label>
                    <div class="mt-2">
                        {% if post.photo_url %}
                            <img id="current-image" src="{{ post.photo_url }}" alt="Imagen del post" class="w-full h-auto rounded-md object-cover border" />
                        {% else %}
                            <div class="w-full h-40 bg-gray-100 rounded-md flex items-center justify-center text-gray-400">Sin imagen</div>
                        {% endif %}
                    </div>
                    <div id="preview-container" class="mt-3"></div>
                </div>

                <div class="md:col-span-2">
                    <label for="id_content" class="block text-sm font-medium text-gray-700">Contenido</label>
                    <div class="mt-2">
                        {{ form.content }}
                        {% if form.content.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.content.errors|first }}</p>
                        {% endif %}
                    </div>

                    <fieldset class="mt-6">
                        <legend class="text-sm font-medium text-gray-700">Cambiar imagen</legend>
                        <p class="text-xs text-gray-400 mt-1">Formato: JPG/PNG/GIF/WEBP — Máx 5MB</p>
                        <div class="mt-3">
                            {{ form.image }}
                            {% if form.image.errors %}
                                <p class="text-red-600 text-sm mt-1">{{ form.image.errors|first }}</p>
                            {% endif %}
                        </div>
                    </fieldset>

                    <div class="mt-6 flex items-center gap-3">
                        <button type="submit" class="inline-flex items-center px-4 py-2 bg-teal-400 text-white rounded-md shadow hover:bg-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-300">Guardar cambios</button>
                        <a href="{% url 'post_view' post.id %}" class="text-sm text-gray-600 hover:underline">Cancelar</a>
                    </div>
                </div>
            </div>
        </form>
    </section>
</main>
{% endblock content %}

{% block extra_scripts %}
<script>
// Previsualización ligera de la imagen seleccionada
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.querySelector('input[type="file"][name$="image"]');
    const previewContainer = document.getElementById('preview-container');
    const currentImage = document.getElementById('current-image');

    function clearPreview() {
        previewContainer.innerHTML = '';
        if (currentImage) currentImage.style.display = '';
    }

    if (!imageInput) return;

    imageInput.addEventListener('change', function(event) {
        previewContainer.innerHTML = '';
        const file = event.target.files && event.target.files[0];
        if (!file) { clearPreview(); return; }

        // Validaciones cliente (ayuda UX)
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowed = ['image/jpeg','image/png','image/gif','image/webp'];
        if (file.size > maxSize) {
            const p = document.createElement('p');
            p.className = 'text-red-600 text-sm';
            p.textContent = 'El archivo excede el tamaño máximo de 5MB.';
            previewContainer.appendChild(p);
            return;
        }
        if (!allowed.includes(file.type)) {
            const p = document.createElement('p');
            p.className = 'text-red-600 text-sm';
            p.textContent = 'Tipo de archivo no permitido.';
            previewContainer.appendChild(p);
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Previsualización de la nueva imagen';
            img.className = 'w-full rounded-md object-cover border';
            previewContainer.appendChild(img);
            if (currentImage) currentImage.style.display = 'none';
        };
        reader.readAsDataURL(file);
    });
});
</script>
{% endblock extra_scripts %}