{% extends 'base.html' %}
{% load static %}
{% load mascota_extras %}
{% block extra_head %}
<title>{{ mascota.name }} - Perfil de Adopci√≥n</title>

<style>
  .gradient-bg {
    background: linear-gradient(135deg, #e8f8f5 0%, #f0f9ff 100%);
  }

  .card-shadow {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .heart-animation {
    transition: all 0.3s ease;
  }

  .heart-animation:hover {
    transform: scale(1.2);
  }

  .liked {
    color: #ef4444;
  }
</style>
{% endblock extra_head %}
{% block content %}

<main class="pt-4">
  <div class="container mx-auto px-4 max-w-4xl">
    <div class="w-full">
  <!-- Header del perfil -->
  <div class="bg-white rounded-3xl card-shadow p-8 mb-6">
    <div class="flex flex-col md:flex-row items-center gap-8">
      <!-- Foto principal -->
      <div class="relative">
        <div class="w-48 h-48 rounded-full overflow-hidden border-4 border-mint">
          {% if mascota.profile_photo_url %}
          <img src="{{ mascota.profile_photo_url }}" alt="Foto de perfil de {{ mascota.name }}"
            class="w-full h-full object-cover" />
          {% else %}
          <img src="{{ post.photo_url|last }}" alt="Foto de perfil de {{ mascota.name }}"
            class="w-full h-full object-cover" />
          {% endif %}
        </div>
        <div
          class="absolute -bottom-2 -right-2 bg-mint text-white rounded-full w-12 h-12 flex items-center justify-center text-xl">
          <i class="fas fa-paw"></i>
        </div>
      </div>

      <!-- Informaci√≥n b√°sica -->
      <div class="flex-1 text-center md:text-left">
        <div>
        <h1 class="text-4xl font-bold text-gray-800 mb-2 inline-block align-middle">
          {{ mascota.name }}
        </h1>
        <div class="inline-block bg-blue-100 text-blue-700 rounded-full px-4 py-1 text-sm font-semibold mr-3 align-middle">
          {{ mascota.tipoAnimal.nombre }}
        </div>
        <p class="text-xl text-gray-600 mb-4">
          {{ mascota.breed }} ‚Ä¢ {{ mascota.age }} a√±os ‚Ä¢ {% if mascota.gender == 'male' %}
          Macho
          {% elif mascota.gender == 'female' %}
          Hembra
          {% else %}
          Desconocido
          {% endif %}
        </p>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-soft-mint p-3 rounded-xl">
            <div class="text-sm text-gray-600">Estado</div>
            {% if mascota.is_available_for_adoption %}
            <div class="font-semibold text-green-600">üü¢ Disponible</div>
            {% else %}
            <div class="font-semibold text-red-600">üî¥ No disponible</div>
            {% endif %}
          </div>
          <div class="bg-blue-50 p-3 rounded-xl">
            <div class="text-sm text-gray-600">Ubicaci√≥n</div>
            <div class="font-semibold text-light-blue">
              üìç {{mascota.ubication}}
            </div>
          </div>
          <div class="bg-soft-mint p-3 rounded-xl">
            <div class="text-sm text-gray-600">Vacunas</div>
            {% if mascota.vacunas %}
            <div class="font-semibold text-green-600">‚úÖ Al d√≠a</div>
            {% else %}
            <div class="font-semibold text-red-600">‚ùå No al d√≠a</div>
            {% endif %}
          </div>
          <div class="bg-blue-50 p-3 rounded-xl">
            <div class="text-sm text-gray-600">Responsable</div>
            <div class="font-semibold text-gray-700">
              {{ mascota.creator.user.first_name }} {{ mascota.creator.user.last_name }}
            </div>
          </div>
          <div class="bg-soft-mint p-3 rounded-xl">
            <div class="text-sm text-gray-600">Desparasitacion</div>
            {% if mascota.desparasitacion %}
            <div class="font-semibold text-green-600">‚úÖ Al d√≠a</div>
            {% else %}
            <div class="font-semibold text-red-600">‚ùå No al d√≠a</div>
            {% endif %}
          </div>
          <div class="bg-soft-mint p-3 rounded-xl">
            <div class="text-sm text-gray-600">Microchip</div>
            {% if mascota.microchip %}
            <div class="font-semibold text-green-600">‚úÖ Implantado</div>
            {% else %}
            <div class="font-semibold text-red-600">‚ùå No implantado</div>
            {% endif %}
          </div>
          <div class="bg-soft-mint p-3 rounded-xl">
            <div class="text-sm text-gray-600">Esterilizaci√≥n</div>
            {% if mascota.sterilization %}
            <div class="font-semibold text-green-600">‚úÖ Esterilizado</div>
            {% else %}
            <div class="font-semibold text-red-600">‚ùå No esterilizado</div>
            {% endif %}
          </div>
        </div>
        {% if post.pet.is_available_for_adoption and mascota.creator.user != request.user %}
          <button
            onclick="showInterest('{{ post.pet.pk }}')"
            class="bg-mint hover:bg-green-400 text-white px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105"
          >
            üíï ¬°Me interesa adoptar!
          </button>
          {% endif %}
      </div>
    </div>
  </div>

  <!-- Informaci√≥n detallada -->
  <div class="bg-white rounded-3xl card-shadow p-8 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">
      Sobre {{ mascota.name }}
    </h2>
    <p class="text-gray-600 leading-relaxed">{{ mascota.description|default:"Sin descripci√≥n" }}</p>
  </div>

  <!-- Publicaciones -->
  <div class="space-y-6">
    <h2 class="text-2xl font-bold text-gray-800 text-center">
      Publicaciones de {{ mascota.name }}
    </h2>
    {% if posts %}
    {% for post in posts %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6 instagram-card">
      <div class="flex items-center px-6 py-4">
        {% if post.pet.profile_photo_url %}
        <img src="{{ post.pet.profile_photo_url }}" alt="{{ post.pet.name }}"
          class="w-12 h-12 rounded-full border-2 border-[#00F5D4] object-cover mr-4">
        {% else %}
        <img src="{% static 'img/logo1.png' %}" alt="Patita azul"
          class="w-12 h-12 rounded-full border-2 border-[#00F5D4] object-cover mr-4">
        {% endif %}
        <div class="flex-1">
          <span class="font-semibold text-gray-900">
            <a href="{% url 'mascotaDetails' post.pet.pk %}">{{ post.pet.name }}</a>
          </span>
          <span class="text-gray-500 font-normal">-{{ post.author.user.username }}</span>
          <div class="text-gray-500 text-sm">{{ post.created_at|date:"d M H:i" }}</div>
        </div>
        {% if post.pet.is_available_for_adoption and post.author.user != request.user %}
    <button
      onclick="showInterest('{{ post.pet.pk }}')"
      class="bg-mint hover:bg-green-400 text-white px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105"
    >
      üíï ¬°Me interesa adoptar!
    </button>
    {% elif post.author.user == request.user %}
    <a href="{% url 'editar_post' post.pk %}">
        <button
            class="p-2 rounded-full border-none bg-transparent shadow-none focus:outline-none"
        >
            <i class="fas fa-edit" title="Editar publicaci√≥n" style="color: #222; font-size: 1.25rem;"></i>
        </button>
    </a>
  <a href="{% url 'eliminar_post' post.pk %}" onclick="return confirm('¬øEst√°s seguro de que deseas eliminar esta publicaci√≥n?')">
    <button
      class="p-2 rounded-full border-none bg-transparent shadow-none focus:outline-none"
      style="background: none;"
    >
      <i class="fas fa-trash" title="Eliminar publicaci√≥n" style="color: #222; font-size: 1.25rem;"></i>
    </button>
  </a>
  {% endif %}
        </div>
        <div class="w-full bg-gray-100">
          <img src="{{ post.photo_url }}" alt="Post" class="object-cover w-full h-auto">
        </div>
        <div class="px-6 py-4">
          <div class="flex items-center mb-4">
            {% if user_authenticated %}
            <button
              class="like-btn {% if post.id in user_liked_post_ids %}text-red-500{% else %}text-gray-500{% endif %} hover:text-red-500 p-2 rounded-full hover:bg-red-50 mr-1">
              <i class="fas fa-heart text-xl"></i>
            </button>
            <style>
              /* Animaci√≥n pop r√°pida para el bot√≥n de like */
              .like-pop {
                animation: like-pop-anim 0.18s cubic-bezier(.4, 2, .6, 1);
              }

              @keyframes like-pop-anim {
                0% {
                  transform: scale(1);
                }

                60% {
                  transform: scale(1.35);
                }

                100% {
                  transform: scale(1);
                }
              }
            </style>
            {% else %}
            <a href="{% url 'login' %}"
              class="text-gray-500 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all duration-300 mr-1 block">
              <i class="fas fa-heart text-xl"></i>
            </a>
            {% endif %}
            <button
              class="text-gray-500 hover:text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-all duration-300 mr-1">
              <i class="fas fa-comment text-xl"></i>
              <span class="ml-1 text-xs align-middle font-semibold">{{ post.comments.count }}</span>
            </button>
            <!-- Bot√≥n de compartir eliminado -->
            <span class="ml-auto text-sm font-semibold text-gray-700 like-count">{{ post.likes.count }} Me gusta</span>
          </div>

          <div class="mb-4">
            <p class="text-gray-900">
              <span class="font-semibold text-gray-900">
                <a href="{% url 'mascotaDetails' post.pet.pk %}">{{ post.pet.name }}</a>
              </span>
              {% if post.content %} {{ post.content }}{% endif %}
            </p>
          </div>

          {% if post.comments.count > 0 %}
          <div class="mb-4 comments-box">
            {% if post.comments.count > 5 %}
            {% for comment in post.comments.all|slice:":5" %}
            <p class="text-sm text-gray-800 mb-1">
              <span class="font-semibold text-gray-900">
                {% if comment.user and comment.user.username %}
                {{ comment.user.username }}
                {% else %}
                Usuario
                {% endif %}
              </span> {{ comment.content }}
            </p>
            {% endfor %}
            <a href="#" class="text-sm text-gray-500 mb-2"
              onclick="this.nextElementSibling.style.display='block';this.style.display='none';return false;">Ver m√°s
              comentarios... </a>
            <div style="display:none;">
              {% for comment in post.comments.all|slice:"5:" %}
              <p class="text-sm text-gray-800 mb-1">
                <span class="font-semibold text-gray-900">
                  {% if comment.user and comment.user.username %}
                  {{ comment.user.username }}
                  {% else %}
                  Usuario
                  {% endif %}
                </span> {{ comment.content }}
              </p>
              {% endfor %}
            </div>
            {% else %}
            {% for comment in post.comments.all %}
            <p class="text-sm text-gray-800 mb-1">
              <span class="font-semibold text-gray-900">
                {% if comment.user and comment.user.username %}
                {{ comment.user.username }}
                {% else %}
                Usuario
                {% endif %}
              </span> {{ comment.content }}
            </p>
            {% endfor %}
            {% endif %}
          </div>
          {% endif %}

          <form method="post" action="" class="comment-form flex items-center border-t border-gray-100 pt-4 gap-3">
            {% csrf_token %}
            <img src="{% static 'img/logo1.png' %}" alt="Tu perfil"
              class="w-8 h-8 rounded-full border border-[#00F5D4] object-cover">
            <input type="hidden" name="comment_post_id" value="{{ post.id }}">
            <input type="text" name="comment_content"
              class="flex-1 bg-gray-50 border-0 rounded-full px-4 py-2 text-sm text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#00F5D4] focus:bg-white transition-all duration-300"
              placeholder="A√±ade un comentario..." {% if not user_authenticated %}disabled{% endif %} required>
            <span class="comment-msg hidden text-green-600 text-xs ml-2"></span>
            {% if not user_authenticated %}
            <a href="{% url 'login' %}"
              class="px-4 py-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all duration-300">Enviar</a>
            {% else %}
            <button type="submit"
              class="px-4 py-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white rounded-full font-semibold text-sm hover:shadow-lg transition-all duration-300">Enviar</button>
            {% endif %}
          </form>
        </div>
      </div>
      {% endfor %}
      {% else %}
    <div class="text-center py-16 bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="text-6xl mb-6">üêæ</div>
      <h3 class="text-2xl font-bold text-gray-900 mb-3">No hay publicaciones a√∫n</h3>
      <p class="text-gray-500 mb-8 max-w-md mx-auto">S√© el primero en compartir una foto de tu mascota y conecta con
        otros amantes de los animales</p>
      {% if not user_authenticated %}
      <a href="{% url 'login' %}"
        class="inline-flex items-center space-x-2 bg-gradient-to-r from-[#00F5D4] to-[#40E0D0] text-white px-8 py-4 rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all duration-300">
        <i class="fas fa-sign-in-alt"></i>
        <span>Iniciar sesi√≥n para publicar</span>
      </a>
      {% endif %}
    </div>
    {% endif %}
    <!-- Footer -->
    {% if mascota.is_available_for_adoption and mascota.creator.user != request.user %}
    <div class="text-center mt-12 p-6">
      <div class="bg-white rounded-2xl card-shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">
          ¬øListo para darle un hogar a {{mascota.name}}?
        </h3>
        <p class="text-gray-600 mb-4">
          Contacta con {{mascota.creator.first_name}} {{mascota.creator.last_name}} para conocer m√°s sobre el proceso de
          adopci√≥n
        </p>
        <button onclick="showInterest('{{ mascota.pk }}')"
          class="bg-mint hover:bg-green-400 text-white px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105">
          üíï ¬°Quiero adoptar a {{mascota.name}}!
        </button>
        
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Modal de inter√©s -->
  <div id="interestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full card-shadow">
      <div class="text-center">
        <div class="text-6xl mb-4">üêïüíï</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-4">
          ¬°Gracias por tu inter√©s!
        </h3>
        <p class="text-gray-600 mb-6">
          {{ mascota.creator.first_name }} {{ mascota.creator.last_name }} se pondr√° en contacto contigo pronto para
          coordinar una visita con
          {{ mascota.name }}.
        </p>
        <div class="space-y-3">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="pet_id" id="adoption-pet-id" value="{{ mascota.pk }}">
            {{ adoption_form.as_p }}
            {% if adoption_form.errors %}
            <div class="text-red-600 text-sm mb-2">
              {{ adoption_form.errors }}
            </div>
            {% endif %}
            <button type="submit"
              class="flex-1 bg-mint text-white py-3 rounded-xl font-semibold hover:bg-green-400 transition-colors">
              Enviar
            </button>
          </form>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="closeModal()"
            class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
            Cancelar
          </button>

        </div>
      </div>
    </div>
  </div>
    </div>
  </div>
</main>
{% endblock content %}
{% block extra_scripts %}
<script>
  function toggleLike(button) {
    const icon = button.querySelector("i");
    const count = button.querySelector("span");
    const currentCount = parseInt(count.textContent);

    if (icon.classList.contains("far")) {
      icon.classList.remove("far");
      icon.classList.add("fas", "liked");
      count.textContent = currentCount + 1;
    } else {
      icon.classList.remove("fas", "liked");
      icon.classList.add("far");
      count.textContent = currentCount - 1;
    }
  }

  function toggleComments(postId) {
    const comments = document.getElementById(`comments-${postId}`);
    comments.classList.toggle("hidden");
  }

  function showInterest() {
    document.getElementById("interestModal").classList.remove("hidden");
  }

  function showInterest(petId) {
    const modal = document.getElementById("interestModal");
    if (modal) modal.classList.remove('hidden');
    const hidden = document.getElementById('adoption-pet-id');
    if (hidden && petId) hidden.value = petId;
  }

  function closeModal() {
    document.getElementById("interestModal").classList.add("hidden");
  }

  function submitInterest() {
    alert(
      "¬°Gracias! Tu solicitud ha sido enviada. Mar√≠a se pondr√° en contacto contigo pronto."
    );
    closeModal();
  }

  function toggleMobileSearch() {
    const mobileSearch = document.getElementById("mobileSearch");
    mobileSearch.classList.toggle("hidden");

    // Cerrar men√∫ m√≥vil si est√° abierto
    const mobileMenu = document.getElementById("mobileMenu");
    if (!mobileMenu.classList.contains("hidden")) {
      mobileMenu.classList.add("hidden");
    }

    // Enfocar en el input de b√∫squeda si se abre
    if (!mobileSearch.classList.contains("hidden")) {
      setTimeout(() => {
        mobileSearch.querySelector("input").focus();
      }, 100);
    }
  }

  function toggleMobileMenu() {
    const mobileMenu = document.getElementById("mobileMenu");
    mobileMenu.classList.toggle("hidden");

    // Cerrar b√∫squeda m√≥vil si est√° abierta
    const mobileSearch = document.getElementById("mobileSearch");
    if (!mobileSearch.classList.contains("hidden")) {
      mobileSearch.classList.add("hidden");
    }
  }

  // Cerrar modal al hacer clic fuera
  document
    .getElementById("interestModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        closeModal();
      }
    });

  // Cerrar men√∫s m√≥viles al redimensionar la ventana
  window.addEventListener("resize", function () {
    if (window.innerWidth >= 768) {
      document.getElementById("mobileSearch").classList.add("hidden");
      document.getElementById("mobileMenu").classList.add("hidden");
    }
  });
</script>
<script>
  (function () {
    function c() {
      var b = a.contentDocument || a.contentWindow.document;
      if (b) {
        var d = b.createElement("script");
        d.innerHTML =
          "window.__CF$cv$params={r:'9809eee593968dc4',t:'MTc1ODEyNjA1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
        b.getElementsByTagName("head")[0].appendChild(d);
      }
    }
    if (document.body) {
      var a = document.createElement("iframe");
      a.height = 1;
      a.width = 1;
      a.style.position = "absolute";
      a.style.top = 0;
      a.style.left = 0;
      a.style.border = "none";
      a.style.visibility = "hidden";
      document.body.appendChild(a);
      if ("loading" !== document.readyState) c();
      else if (window.addEventListener)
        document.addEventListener("DOMContentLoaded", c);
      else {
        var e = document.onreadystatechange || function () { };
        document.onreadystatechange = function (b) {
          e(b);
          "loading" !== document.readyState &&
            ((document.onreadystatechange = e), c());
        };
      }
    }
  })();
</script>

<style>
  .animate-fadein {
    animation: fadein 0.3s;
  }

  .animate-slideup {
    animation: slideup 0.4s cubic-bezier(.4, 2, .6, 1) 0.05s;
  }

  @keyframes fadein {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes slideup {
    from {
      transform: translateY(40px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .text-mint {
    color: #00F5D4;
  }

  .bg-mint {
    background: #00F5D4;
  }

  .bg-mint\/90 {
    background: rgba(0, 245, 212, 0.9);
  }

  /* Minimalista para los inputs */
  #interestModal input,
  #interestModal textarea {
    background: #f7fafc;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 1rem;
    color: #222;
    padding: 0.75rem 1rem;
    transition: border 0.2s, box-shadow 0.2s;
    box-shadow: none;
    outline: none;
  }

  #interestModal input:focus,
  #interestModal textarea:focus {
    border-color: #00F5D4;
    background: #fff;
  }

  #interestModal textarea {
    min-height: 80px;
    resize: vertical;
  }
</style>

<style>
  .animate-bounce-brown {
    animation: bounce-brown 0.7s infinite alternate;
    display: inline-block;
  }

  @keyframes bounce-brown {
    0% {
      transform: translateY(0);
    }

    100% {
      transform: translateY(-16px);
    }
  }
</style>
<script>
  function showInterest() {
    document.getElementById("interestModal").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("interestModal").classList.add("hidden");
  }
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof Swiper !== 'undefined') {
      const swiper = new Swiper('.swiper', {
        slidesPerView: 'auto',
        spaceBetween: 12,
        freeMode: true,
        grabCursor: true
      });
    }

    document.querySelectorAll('.instagram-card').forEach(function (card) {
      const likeBtn = card.querySelector('.like-btn');
      const likeCount = card.querySelector('.like-count');

      if (likeBtn && likeCount) {
        let liked = likeBtn.classList.contains('text-red-500');
        let count = parseInt(likeCount.textContent) || 0;

        likeBtn.addEventListener('click', function (e) {
          e.preventDefault();
          liked = !liked;

          if (liked) {
            likeBtn.classList.add('text-red-500');
            likeBtn.classList.remove('text-gray-500');
            count++;
          } else {
            likeBtn.classList.remove('text-red-500');
            likeBtn.classList.add('text-gray-500');
            count--;
          }

          likeCount.textContent = count + ' Me gusta';
        });
      }
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const modal = document.getElementById('modal-publicando');
      if (modal) {
        modal.classList.add('hidden');
      }
    }
  });
</script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/comments.js' %}"></script>
<script src="{% static 'js/like.js' %}"></script>
{% endblock extra_scripts %}